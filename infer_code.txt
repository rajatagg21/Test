import numpy as np
import tensorflow as tf

LABEL_MAP = {
    0: "others",
    1: "promotion"
}

def infer(model, text, threshold=0.5):
    """
    Perform inference on a single string or list of strings.

    Args:
        model: trained TF model
        text: str or List[str]
        threshold: probability cutoff to assign 'promotion'

    Returns:
        List of dicts: [{"text": "...", "prob": float, "label": str}]
    """

    # Normalize input â†’ always list
    if isinstance(text, str):
        text_list = [text]
    else:
        text_list = text

    # Convert to tensors with correct shape (batch, 1)
    input_tensor = tf.constant(text_list, dtype=tf.string)
    input_tensor = tf.expand_dims(input_tensor, axis=1)  # shape: (B, 1)

    # Predict
    probs = model.predict(input_tensor).flatten()

    results = []
    for t, p in zip(text_list, probs):
        label = LABEL_MAP[int(p >= threshold)]
        results.append({
            "text": t,
            "prob": float(p),
            "label": label
        })

    return results
